{% extends "base.html" %}

{% block title %}Dysgraphia Assessment Results - Neurobloom{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%) !important;
        min-height: 100vh !important;
    }

    .container {
        background: transparent !important;
        padding: 0 !important;
    }

    .results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        padding-top: 120px;
    }

    .results-header {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 40px;
        animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header-title h1 {
        color: #fff;
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .header-title p {
        color: #b0b0c0;
        font-size: 1em;
    }

    .header-meta {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }

    .meta-item {
        text-align: center;
    }

    .meta-label {
        color: #b0b0c0;
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .meta-value {
        color: #95E1D3;
        font-size: 1.5em;
        font-weight: bold;
    }

    .attempts-selector {
        background: rgba(149, 225, 211, 0.1);
        border: 1px solid rgba(149, 225, 211, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 40px;
    }

    .attempts-selector h2 {
        color: #fff;
        margin-bottom: 15px;
        font-size: 1.3em;
    }

    .attempts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .attempt-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .attempt-card:hover {
        background: rgba(149, 225, 211, 0.2);
        border-color: #95E1D3;
        transform: translateY(-5px);
    }

    .attempt-card.active {
        background: rgba(149, 225, 211, 0.3);
        border-color: #95E1D3;
    }

    .attempt-number {
        color: #95E1D3;
        font-size: 0.9em;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .attempt-date {
        color: #fff;
        font-size: 1em;
        margin-bottom: 10px;
    }

    .attempt-score {
        background: linear-gradient(135deg, #95E1D3 0%, #7ECDC8 100%);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.3em;
    }

    .results-content {
        display: none;
        animation: fadeIn 0.4s ease-out;
    }

    .results-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-section {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .section-title {
        color: #fff;
        font-size: 1.5em;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(149, 225, 211, 0.3);
    }

    .risk-badge {
        display: inline-block;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .risk-high {
        background: rgba(244, 67, 54, 0.2);
        color: #ff6b6b;
    }

    .risk-medium {
        background: rgba(255, 152, 0, 0.2);
        color: #ffa726;
    }

    .risk-low {
        background: rgba(76, 175, 80, 0.2);
        color: #66bb6a;
    }

    .risk-none {
        background: rgba(149, 225, 211, 0.2);
        color: #95E1D3;
    }

    .tasks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .task-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .task-card:hover {
        background: rgba(149, 225, 211, 0.1);
        border-color: #95E1D3;
    }

    .task-name {
        color: #95E1D3;
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1em;
    }

    .task-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #b0b0c0;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .task-stat:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .stat-label {
        font-size: 0.9em;
    }

    .stat-value {
        color: #fff;
        font-weight: 600;
    }

    .accuracy-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
    }

    .bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #95E1D3, #7ECDC8);
        border-radius: 4px;
    }

    .bar-text {
        color: #95E1D3;
        font-weight: 600;
        font-size: 0.9em;
        min-width: 45px;
    }

    .warnings-section {
        background: rgba(255, 152, 0, 0.05);
        border-left: 4px solid #ffa726;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
    }

    .warnings-title {
        color: #ffa726;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 0.95em;
    }

    .warning-item {
        color: #b0b0c0;
        font-size: 0.9em;
        margin-bottom: 8px;
        padding-left: 10px;
    }

    .warning-item:last-child {
        margin-bottom: 0;
    }

    .recommendations {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .recommendation-card {
        background: rgba(149, 225, 211, 0.1);
        border: 1px solid rgba(149, 225, 211, 0.3);
        border-radius: 10px;
        padding: 20px;
    }

    .rec-title {
        color: #95E1D3;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .rec-content {
        color: #b0b0c0;
        font-size: 0.9em;
        line-height: 1.5;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 40px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 12px 28px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #95E1D3 0%, #7ECDC8 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(149, 225, 211, 0.3);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .loading {
        text-align: center;
        color: #b0b0c0;
        padding: 40px;
    }

    .error-message {
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        color: #ff6b6b;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .info-message {
        background: rgba(78, 205, 196, 0.1);
        border: 1px solid rgba(78, 205, 196, 0.3);
        color: #4ECDC4;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .tasks-grid {
            grid-template-columns: 1fr;
        }

        .header-title h1 {
            font-size: 1.8em;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
    <!-- Header -->
    <div class="results-header">
        <div class="header-content">
            <div class="header-title">
                <h1>üéÆ Dysgraphia Assessment Results</h1>
                <p id="assessmentStatus"></p>
            </div>
            <div class="header-meta">
                <div class="meta-item">
                    <div class="meta-label">Total Attempts</div>
                    <div class="meta-value" id="totalAttempts">0</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Latest Score</div>
                    <div class="meta-value" id="latestScore">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attempt Selector -->
    <div class="attempts-selector" id="attemptsSelector">
        <h2>üìã Select Attempt to View</h2>
        <div class="attempts-grid" id="attemptsGrid">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Results Content -->
    <div id="resultsContent">
        <!-- Risk Assessment -->
        <div class="result-section">
            <div class="section-title">üéØ Risk Assessment</div>
            <div id="riskAssessment">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Task Results -->
        <div class="result-section">
            <div class="section-title">üìä Task-by-Task Performance</div>
            <div class="tasks-grid" id="tasksGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Recommendations -->
        <div class="result-section">
            <div class="section-title">üí° Recommendations</div>
            <div class="recommendations" id="recommendationsGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="window.location.href='/assessments'">
                Back to Assessments
            </button>
            <button class="btn btn-secondary" onclick="downloadReport()">
                Download Report
            </button>
        </div>
    </div>
</div>

<script>
    const assessmentId = parseInt('{{ assessment_id }}');
    let allAttempts = [];
    let currentAttemptIndex = 0;

    document.addEventListener('DOMContentLoaded', function() {
        loadAssessmentAttempts();
    });

    async function loadAssessmentAttempts() {
        try {
            const response = await fetch(`/api/dysgraphia-results/${assessmentId}`);
            const data = await response.json();

            allAttempts = data.attempts || [];
            
            // Handle empty results gracefully
            if (allAttempts.length === 0) {
                showInfo(data.message || 'No assessment attempts found. Complete an assessment to see results here.');
                return;
            }

            displayAttempts();
            displayResults(allAttempts[0]);

            const totalEl = document.getElementById('totalAttempts');
            const scoreEl = document.getElementById('latestScore');
            const statusEl = document.getElementById('assessmentStatus');
            
            if (totalEl) totalEl.textContent = allAttempts.length;
            if (scoreEl) scoreEl.textContent = getRiskBadgeText(allAttempts[0].risk_level);
            if (statusEl) statusEl.textContent = 'All your dysgraphia assessment attempts';

        } catch (error) {
            console.error('Error loading attempts:', error);
            showError('An error occurred while loading results');
        }
    }

    function displayAttempts() {
        const grid = document.getElementById('attemptsGrid');
        grid.innerHTML = '';

        allAttempts.forEach((attempt, index) => {
            const card = document.createElement('div');
            card.className = `attempt-card ${index === 0 ? 'active' : ''}`;
            card.onclick = () => selectAttempt(index);

            const date = new Date(attempt.created_at);
            card.innerHTML = `
                <div class="attempt-number">Attempt ${allAttempts.length - index}</div>
                <div class="attempt-date">${date.toLocaleDateString()}</div>
                <div class="attempt-score">${getRiskBadgeText(attempt.risk_level)}</div>
            `;

            grid.appendChild(card);
        });
    }

    function selectAttempt(index) {
        currentAttemptIndex = index;
        
        document.querySelectorAll('.attempt-card').forEach((card, i) => {
            card.classList.toggle('active', i === index);
        });

        displayResults(allAttempts[index]);
    }

    function displayResults(attempt) {
        if (!attempt) {
            console.warn('No attempt data provided');
            return;
        }
        
        const riskSection = document.getElementById('riskAssessment');
        if (!riskSection) {
            console.warn('riskAssessment element not found');
            return;
        }
        
        const riskClass = getRiskClass(attempt.risk_level);
        riskSection.innerHTML = `
            <div class="risk-badge ${riskClass}">${getRiskBadgeText(attempt.risk_level)}</div>
            <p style="color: #b0b0c0; margin-bottom: 20px;">Assessment completed on ${new Date(attempt.created_at).toLocaleDateString()}</p>
            <div style="color: #fff; line-height: 1.6;">
                <p><strong>Overall Assessment:</strong></p>
                <p style="color: #b0b0c0; margin-top: 10px;">${getRiskDescription(attempt.risk_level)}</p>
            </div>
        `;

        const tasksGrid = document.getElementById('tasksGrid');
        if (!tasksGrid) {
            console.warn('tasksGrid element not found');
            return;
        }
        tasksGrid.innerHTML = '';

        const tasksData = attempt.results;
        const taskNames = {
            'trace_line': 'üìç Trace the Line',
            'copy_letter': 'üìù Copy the Letter',
            'write_audio': 'üé§ Write from Audio',
            'timed_write': '‚è±Ô∏è Timed Writing',
            'shape_draw': 'üî∑ Draw Shapes'
        };

        for (const [taskKey, taskName] of Object.entries(taskNames)) {
            if (tasksData[taskKey]) {
                const task = tasksData[taskKey];
                const smoothness = task.smoothness || 0.5;
                
                const card = document.createElement('div');
                card.className = 'task-card';
                card.innerHTML = `
                    <div class="task-name">${taskName}</div>
                    
                    <div class="task-stat">
                        <span class="stat-label">Smoothness</span>
                        <span class="stat-value">${(smoothness * 100).toFixed(0)}%</span>
                    </div>

                    <div class="accuracy-bar">
                        <div class="bar">
                            <div class="bar-fill" style="width: ${smoothness * 100}%"></div>
                        </div>
                        <div class="bar-text">${(smoothness).toFixed(2)}</div>
                    </div>

                    <div class="task-stat">
                        <span class="stat-label">Duration</span>
                        <span class="stat-value">${(task.duration_ms / 1000).toFixed(1)}s</span>
                    </div>
                `;
                tasksGrid.appendChild(card);
            }
        }

        const existingWarnings = document.querySelector('.warnings-section');
        if (existingWarnings) {
            existingWarnings.remove();
        }
        
        if (attempt.details && attempt.details.warnings && attempt.details.warnings.length > 0) {
            const warningsHtml = `
                <div class="warnings-section">
                    <div class="warnings-title">‚ö†Ô∏è Performance Notes</div>
                    ${attempt.details.warnings.map(w => `<div class="warning-item">‚Ä¢ ${w}</div>`).join('')}
                </div>
            `;
            tasksGrid.insertAdjacentHTML('afterend', warningsHtml);
        }

        const recsGrid = document.getElementById('recommendationsGrid');
        recsGrid.innerHTML = '';

        const recommendations = getRecommendations(attempt.risk_level);
        recommendations.forEach(rec => {
            const card = document.createElement('div');
            card.className = 'recommendation-card';
            card.innerHTML = `
                <div class="rec-title">${rec.icon} ${rec.title}</div>
                <div class="rec-content">${rec.description}</div>
            `;
            recsGrid.appendChild(card);
        });
    }

    function getRiskClass(riskLevel) {
        if (riskLevel.includes('High')) return 'risk-high';
        if (riskLevel.includes('Medium')) return 'risk-medium';
        if (riskLevel.includes('Low')) return 'risk-low';
        return 'risk-none';
    }

    function getRiskBadgeText(riskLevel) {
        if (riskLevel.includes('High')) return 'High Risk';
        if (riskLevel.includes('Medium')) return 'Medium Risk';
        if (riskLevel.includes('Low')) return 'Low Risk';
        return 'No Risk';
    }

    function getRiskDescription(riskLevel) {
        const descriptions = {
            'High risk': 'Based on your performance, early intervention and specialized support are recommended. Consider consulting with a dysgraphia specialist.',
            'Medium risk': 'Your performance suggests some areas that may benefit from targeted practice and monitoring. Continue handwriting practice.',
            'Low risk': 'Great performance! Continue with regular handwriting practice to maintain and improve your skills.',
            'No risk likely': 'Excellent performance! You demonstrate strong handwriting and writing skills.'
        };
        return descriptions[riskLevel] || 'Assessment complete.';
    }

    function getRecommendations(riskLevel) {
        const recommendations = [
            {
                icon: '‚úèÔ∏è',
                title: 'Handwriting Practice',
                description: 'Engage in regular handwriting practice with age-appropriate materials and proper posture.'
            },
            {
                icon: 'üéÆ',
                title: 'Writing Games',
                description: 'Continue using interactive writing games to build fine motor skills and handwriting proficiency.'
            },
            {
                icon: 'üë®‚Äçüè´',
                title: 'Professional Support',
                description: 'If high risk is indicated, consider consulting with an occupational therapist or writing specialist.'
            }
        ];

        if (riskLevel.includes('High')) {
            recommendations.push({
                icon: 'üè•',
                title: 'Clinical Assessment',
                description: 'A comprehensive dysgraphia evaluation by a licensed professional is highly recommended.'
            });
        }

        return recommendations;
    }

    function showError(message) {
        const container = document.querySelector('.results-container');
        container.innerHTML = `
            <div class="error-message">
                <h2>Error Loading Results</h2>
                <p>${message}</p>
                <button class="btn btn-secondary" onclick="window.location.href='/assessments'">
                    Back to Assessments
                </button>
            </div>
        `;
    }

    function showInfo(message) {
        const container = document.querySelector('.results-container');
        container.innerHTML = `
            <div class="info-message">
                <h2>No Results Yet</h2>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="window.location.href='/assessments'">
                    Go to Assessments
                </button>
            </div>
        `;
    }

    function downloadReport() {
        const attempt = allAttempts[currentAttemptIndex];
        let reportContent = 'DYSGRAPHIA ASSESSMENT REPORT\n';
        reportContent += '='.repeat(50) + '\n\n';
        reportContent += `Assessment Date: ${new Date(attempt.created_at).toLocaleDateString()}\n`;
        reportContent += `Risk Level: ${getRiskBadgeText(attempt.risk_level)}\n\n`;
        reportContent += 'TASK RESULTS:\n';
        reportContent += '-'.repeat(50) + '\n';

        const taskNames = {
            'trace_line': 'Trace the Line',
            'copy_letter': 'Copy the Letter',
            'write_audio': 'Write from Audio',
            'timed_write': 'Timed Writing',
            'shape_draw': 'Draw Shapes'
        };

        for (const [taskKey, taskName] of Object.entries(taskNames)) {
            if (attempt.results[taskKey]) {
                const task = attempt.results[taskKey];
                reportContent += `\n${taskName}:\n`;
                reportContent += `  Smoothness: ${((task.smoothness || 0) * 100).toFixed(0)}%\n`;
                reportContent += `  Duration: ${(task.duration_ms / 1000).toFixed(1)}s\n`;
            }
        }

        if (attempt.details && attempt.details.warnings) {
            reportContent += '\n' + '-'.repeat(50) + '\nNOTES:\n';
            attempt.details.warnings.forEach(w => {
                reportContent += `‚Ä¢ ${w}\n`;
            });
        }

        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(reportContent));
        element.setAttribute('download', `dysgraphia_report_${new Date().toISOString().split('T')[0]}.txt`);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
</script>
{% endblock %}
