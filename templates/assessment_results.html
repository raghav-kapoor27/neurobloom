{% extends "base.html" %}

{% block title %}Assessment Results - Neurobloom{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='assessment_results.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .results-header-wrapper {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .btn-back-dashboard {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        white-space: nowrap;
    }

    .btn-back-dashboard:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }

    .btn-back-dashboard:active {
        transform: translateY(0);
    }

    .btn-profile-link {
        padding: 10px 20px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        color: #667eea;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        text-decoration: none;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-profile-link:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
        border-color: rgba(102, 126, 234, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="assessment-results-container">
    <!-- Back Button -->
    <div class="results-header-wrapper">
        <button class="btn-back-dashboard" onclick="goToDashboard()">
            ‚Üê Back to Dashboard
        </button>
        <a href="/student-profile" class="btn-profile-link" title="View your profile">
            üë§ My Profile
        </a>
    </div>

    <!-- Header Section -->
    <div class="results-header">
        <div class="results-title">
            <h1>Assessment Results</h1>
            <p class="disorder-name" id="disorderName"></p>
        </div>
        <div class="results-date">
            <p id="assessmentDate"></p>
        </div>
    </div>

    <!-- Score Summary Card -->
    <div class="score-summary-card">
        <div class="score-circle">
            <svg viewBox="0 0 120 120" class="progress-ring">
                <circle cx="60" cy="60" r="54" class="progress-ring-background"></circle>
                <circle cx="60" cy="60" r="54" class="progress-ring-foreground" id="scoreRing"></circle>
            </svg>
            <div class="score-text">
                <div class="percentage" id="scorePercentage">0%</div>
                <div class="label">Score</div>
            </div>
        </div>

        <div class="summary-stats">
            <div class="stat-box">
                <div class="stat-icon">‚úì</div>
                <div class="stat-content">
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-icon">‚è±</div>
                <div class="stat-content">
                    <div class="stat-value" id="timeTaken">0m</div>
                    <div class="stat-label">Time Taken</div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalQuestions">0</div>
                    <div class="stat-label">Total Questions</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Prediction Section -->
    <div class="prediction-section" id="predictionSection">
        <div class="section-header">
            <h2>üìà AI Analysis & Risk Assessment</h2>
        </div>

        <div class="prediction-card">
            <div class="risk-indicator">
                <div class="risk-badge" id="riskBadge"></div>
                <div class="risk-info">
                    <div class="risk-level" id="riskLevel"></div>
                    <div class="risk-confidence">
                        Confidence: <span id="confidence">0%</span>
                    </div>
                </div>
            </div>

            <div class="prediction-score">
                <div class="prediction-label">Prediction Score</div>
                <div class="prediction-bar-container">
                    <div class="prediction-bar" id="predictionBar"></div>
                    <div class="prediction-percentage" id="predictionPercentage">0%</div>
                </div>
            </div>
        </div>

        <!-- Recommendations Section -->
        <div class="recommendations-section" id="recommendationsSection">
            <div class="section-header">
                <h3>üí° Recommended Interventions</h3>
            </div>

            <div class="recommendations-grid" id="recommendationsGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Detailed Performance Analysis -->
    <div class="analysis-metrics-section">
        <div class="section-header">
            <h2>üìä Detailed Performance Analysis</h2>
        </div>

        <div class="metrics-grid" id="metricsGrid">
            <!-- Populated by JavaScript with difficulty breakdown -->
        </div>
    </div>

    <!-- Question-by-Question Breakdown -->
    <div class="detailed-breakdown-section">
        <div class="section-header">
            <h2>Question-by-Question Breakdown</h2>
            <div class="filter-options">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="correct">Correct</button>
                <button class="filter-btn" data-filter="incorrect">Incorrect</button>
            </div>
        </div>

        <div class="questions-breakdown" id="questionsBreakdown">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Performance Analytics -->
    <div class="analytics-section">
        <div class="section-header">
            <h2>Performance Analytics</h2>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <h3>Difficulty Performance</h3>
                <canvas id="difficultyChart" width="400" height="300"></canvas>
            </div>

            <div class="chart-box">
                <h3>Score Distribution</h3>
                <canvas id="trendChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="window.location.href='/assessments'">
            Take Another Assessment
        </button>
        <button class="btn btn-secondary" onclick="downloadReport()">
            Download Report
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/student?v=' + new Date().getTime()">
            Back to Dashboard
        </button>
    </div>
</div>

<script>
// Assessment data from Flask
const assessmentId = parseInt('{{ assessment_id }}');
const studentAssessmentId = parseInt('{{ student_assessment_id }}');

// Charts
let difficultyChart = null;
let trendChart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadAssessmentResults();
});

async function loadAssessmentResults() {
    try {
        // If no studentAssessmentId, show error
        if (!studentAssessmentId) {
            showError('Assessment ID not found');
            return;
        }

        const response = await fetch(`/api/student-assessment/${studentAssessmentId}/results`);
        const data = await response.json();

        if (!response.ok) {
            showError(data.error || 'Failed to load results');
            return;
        }

        displayResults(data);
    } catch (error) {
        console.error('Error loading results:', error);
        showError('An error occurred while loading results');
    }
}

function displayResults(data) {
    const assessment = data.assessment;
    const answers = data.answers;
    const prediction = data.prediction;
    const detailedAnalysis = data.detailed_analysis;

    // Update header
    document.getElementById('disorderName').textContent = assessment.disorder_type.charAt(0).toUpperCase() + assessment.disorder_type.slice(1) + ' Assessment';
    document.getElementById('assessmentDate').textContent = new Date(assessment.end_time).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // Update score summary
    const percentage = assessment.percentage_score;
    document.getElementById('scorePercentage').textContent = Math.round(percentage) + '%';
    document.getElementById('correctAnswers').textContent = assessment.total_correct || Math.round(assessment.total_score / 5);
    
    // Format time taken (convert minutes to hh:mm or mm format)
    const timeTaken = assessment.time_taken_minutes || 0;
    let formattedTime = '';
    if (timeTaken >= 60) {
        const hours = Math.floor(timeTaken / 60);
        const minutes = timeTaken % 60;
        formattedTime = `${hours}h ${minutes}m`;
    } else {
        formattedTime = `${timeTaken}m`;
    }
    document.getElementById('timeTaken').textContent = formattedTime;
    
    document.getElementById('totalQuestions').textContent = answers.length;

    // Update score ring
    updateScoreRing(percentage);

    // Display ML prediction if available
    if (prediction) {
        displayPrediction(prediction, assessment.disorder_type);
    }

    // Display detailed analysis if available
    if (detailedAnalysis && detailedAnalysis.by_difficulty) {
        displayDetailedAnalysis(detailedAnalysis);
    }

    // Display question breakdown
    displayQuestionBreakdown(answers);

    // Generate charts
    generateCharts(answers);
}

function updateScoreRing(percentage) {
    const radius = 54;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (percentage / 100) * circumference;

    const ring = document.getElementById('scoreRing');
    ring.style.strokeDasharray = circumference;
    ring.style.strokeDashoffset = offset;

    // Change color based on score
    if (percentage >= 80) {
        ring.style.stroke = '#4CAF50';
    } else if (percentage >= 60) {
        ring.style.stroke = '#FF9800';
    } else {
        ring.style.stroke = '#f44336';
    }
}

function displayPrediction(prediction, disorderType) {
    const predictionScore = prediction.prediction_score || 0;
    const riskLevel = prediction.risk_level || 'Unknown';
    const confidence = prediction.confidence_score || 0;

    // Update risk badge
    const riskBadge = document.getElementById('riskBadge');
    const riskColor = riskLevel === 'HIGH' ? '#f44336' : riskLevel === 'MEDIUM' ? '#FF9800' : '#4CAF50';
    riskBadge.style.borderColor = riskColor;
    riskBadge.style.backgroundColor = riskColor + '15';
    riskBadge.textContent = riskLevel;

    // Update risk info
    const riskLevelText = {
        'HIGH': 'High Risk - Intervention Recommended',
        'MEDIUM': 'Medium Risk - Monitoring Advised',
        'LOW': 'Low Risk - Good Performance'
    };
    document.getElementById('riskLevel').textContent = riskLevelText[riskLevel] || 'Unknown';
    document.getElementById('confidence').textContent = Math.round(confidence * 100) + '%';

    // Update prediction bar
    const predictionBar = document.getElementById('predictionBar');
    predictionBar.style.width = (predictionScore * 100) + '%';
    predictionBar.style.backgroundColor = riskColor;
    document.getElementById('predictionPercentage').textContent = Math.round(predictionScore * 100) + '%';

    // Display recommendations
    if (prediction.recommendations && Array.isArray(prediction.recommendations)) {
        displayRecommendations(prediction.recommendations);
    }
}

function displayDetailedAnalysis(analysis) {
    const grid = document.getElementById('metricsGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // Display overall metrics
    const overallMetrics = analysis.overall;
    if (overallMetrics && Object.keys(overallMetrics).length > 0) {
        const overallCard = document.createElement('div');
        overallCard.className = 'metric-card overall';
        overallCard.innerHTML = `
            <div class="metric-title">Overall Performance</div>
            <div class="metric-stat">
                <span class="metric-label">Accuracy:</span>
                <span class="metric-value">${overallMetrics.accuracy_percent}%</span>
            </div>
            <div class="metric-stat">
                <span class="metric-label">Avg Response Time:</span>
                <span class="metric-value">${Math.round(overallMetrics.avg_response_time_ms)}ms</span>
            </div>
            <div class="metric-stat">
                <span class="metric-label">Score:</span>
                <span class="metric-value">${overallMetrics.total_correct}/${overallMetrics.total_questions}</span>
            </div>
        `;
        grid.appendChild(overallCard);
    }
    
    // Display by difficulty
    if (analysis.by_difficulty) {
        const difficulties = ['easy', 'medium', 'hard'];
        const difficultyLabels = {
            'easy': 'üü¢ Easy',
            'medium': 'üü° Medium',
            'hard': 'üî¥ Hard'
        };
        
        difficulties.forEach(difficulty => {
            const data = analysis.by_difficulty[difficulty];
            if (data && data.total > 0) {
                const card = document.createElement('div');
                card.className = `metric-card ${difficulty}`;
                card.innerHTML = `
                    <div class="metric-title">${difficultyLabels[difficulty]}</div>
                    <div class="metric-stat">
                        <span class="metric-label">Accuracy:</span>
                        <span class="metric-value">${data.accuracy}%</span>
                    </div>
                    <div class="metric-stat">
                        <span class="metric-label">Avg Response:</span>
                        <span class="metric-value">${Math.round(data.avg_response_time_ms)}ms</span>
                    </div>
                    <div class="metric-stat">
                        <span class="metric-label">Score:</span>
                        <span class="metric-value">${data.correct}/${data.total}</span>
                    </div>
                `;
                grid.appendChild(card);
            }
        });
    }
}

function displayRecommendations(recommendations) {
    const grid = document.getElementById('recommendationsGrid');
    grid.innerHTML = '';

    if (!recommendations || recommendations.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary);">No recommendations available.</p>';
        return;
    }

    recommendations.forEach((rec, index) => {
        const recCard = document.createElement('div');
        recCard.className = 'recommendation-card';
        
        // Parse recommendation string
        let title = 'Recommendation';
        let description = '';
        let riskIndicator = '';
        let content = rec;
        
        if (typeof rec === 'string') {
            // Extract risk indicator emoji/symbol if present
            const indicatorMatch = rec.match(/^(‚ö†|üî¥|‚úì|‚ÑπÔ∏è|üí°|üéì|üìö|üè•|üë®‚Äçüè´|\d+\.)\s*/);
            if (indicatorMatch) {
                riskIndicator = indicatorMatch[0].trim();
                content = rec.substring(indicatorMatch[0].length);
            }
            
            // Split by dash or first sentence break to extract title
            const lines = content.split('\n');
            if (lines.length > 0) {
                // First line becomes title (up to 80 chars or first dash)
                const firstLine = lines[0];
                const dashIndex = firstLine.indexOf(' - ');
                if (dashIndex > 0) {
                    title = firstLine.substring(0, dashIndex).trim();
                    description = firstLine.substring(dashIndex + 3).trim() + 
                                 (lines.length > 1 ? '\n' + lines.slice(1).join('\n') : '');
                } else {
                    title = firstLine.substring(0, 80).trim();
                    description = (lines.length > 1 ? lines.slice(1).join('\n') : '');
                }
            }
        } else if (typeof rec === 'object' && rec !== null) {
            // Handle object format
            title = rec.title || 'Recommendation';
            description = rec.description || '';
            riskIndicator = rec.riskIndicator || '';
        }
        
        // Determine risk level color based on indicator
        let riskClass = 'risk-low';
        if (riskIndicator.includes('üî¥') || riskIndicator.includes('‚ö†')) {
            if (content.includes('URGENT') || content.includes('CRITICAL')) {
                riskClass = 'risk-critical';
            } else if (content.includes('INTERVENTION')) {
                riskClass = 'risk-high';
            } else if (content.includes('MONITOR')) {
                riskClass = 'risk-medium';
            }
        } else if (riskIndicator.includes('‚úì')) {
            riskClass = 'risk-none';
        }
        
        // Format description with better line breaks and HTML safety
        const formattedDesc = description
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0)
            .join('<br>');
        
        recCard.className = `recommendation-card ${riskClass}`;
        recCard.innerHTML = `
            <div class="rec-header">
                <div class="rec-number">${index + 1}</div>
                ${riskIndicator ? `<span class="risk-indicator">${riskIndicator}</span>` : ''}
            </div>
            <h4>${escapeHtml(title)}</h4>
            ${formattedDesc ? `<p>${escapeHtml(description).split('\n').join('<br>')}</p>` : ''}
        `;
        grid.appendChild(recCard);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function displayQuestionBreakdown(answers) {
    const breakdown = document.getElementById('questionsBreakdown');
    breakdown.innerHTML = '';

    answers.forEach((answer, index) => {
        const isCorrect = answer.is_correct;
        const questionCard = document.createElement('div');
        questionCard.className = `question-card ${isCorrect ? 'correct' : 'incorrect'} ${answer.difficulty_level || 'medium'}`;
        questionCard.setAttribute('data-status', isCorrect ? 'correct' : 'incorrect');

        questionCard.innerHTML = `
            <div class="question-header">
                <span class="question-number">Q${index + 1}</span>
                <span class="difficulty-badge">${answer.difficulty_level || 'Medium'}</span>
                <span class="status-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
            </div>
            <div class="question-text">${answer.question_text}</div>
            <div class="answer-section">
                <div class="student-answer">
                    <strong>Your Answer:</strong> ${answer.student_answer || 'Not answered'}
                </div>
                ${!isCorrect ? `
                    <div class="explanation">
                        <strong>Explanation:</strong> ${answer.explanation || 'No explanation available'}
                    </div>
                ` : ''}
            </div>
        `;

        breakdown.appendChild(questionCard);
    });

    // Add filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const filter = this.dataset.filter;
            document.querySelectorAll('.question-card').forEach(card => {
                if (filter === 'all') {
                    card.style.display = '';
                } else if (filter === card.dataset.status) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
}

function generateCharts(answers) {
    // Difficulty Performance Chart
    const difficultyData = {
        easy: { correct: 0, total: 0 },
        medium: { correct: 0, total: 0 },
        hard: { correct: 0, total: 0 }
    };

    answers.forEach(answer => {
        const difficulty = answer.difficulty_level.toLowerCase();
        if (difficultyData[difficulty]) {
            difficultyData[difficulty].total++;
            if (answer.is_correct) {
                difficultyData[difficulty].correct++;
            }
        }
    });

    const diffCanvas = document.getElementById('difficultyChart');
    if (diffCanvas) {
        const ctx = diffCanvas.getContext('2d');
        const gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
        gradient1.addColorStop(0, '#00ffff');
        gradient1.addColorStop(1, '#0099ff');
        
        const gradient2 = ctx.createLinearGradient(0, 0, 0, 300);
        gradient2.addColorStop(0, '#ff00ff');
        gradient2.addColorStop(1, '#ff0088');
        
        const gradient3 = ctx.createLinearGradient(0, 0, 0, 300);
        gradient3.addColorStop(0, '#00ff00');
        gradient3.addColorStop(1, '#00dd44');
        
        difficultyChart = new Chart(diffCanvas, {
            type: 'bar',
            data: {
                labels: ['Easy', 'Medium', 'Hard'],
                datasets: [{
                    label: 'Correct Answers',
                    data: [
                        difficultyData.easy.correct,
                        difficultyData.medium.correct,
                        difficultyData.hard.correct
                    ],
                    backgroundColor: [gradient1, gradient2, gradient3],
                    borderColor: ['#00ffff', '#ff00ff', '#00ff00'],
                    borderWidth: 3,
                    borderRadius: 8,
                    hoverBackgroundColor: ['#00ffff', '#ff00ff', '#00ff00']
                },
                {
                    label: 'Total Questions',
                    data: [
                        difficultyData.easy.total,
                        difficultyData.medium.total,
                        difficultyData.hard.total
                    ],
                    backgroundColor: 'rgba(255, 255, 255, 0.2)',
                    borderColor: 'rgba(255, 255, 255, 0.5)',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'x',
                plugins: {
                    legend: { 
                        display: true,
                        labels: {
                            color: '#ffffff',
                            font: { size: 14, weight: 'bold' },
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.95)',
                        titleColor: '#00ffff',
                        bodyColor: '#ffffff',
                        borderColor: '#00ffff',
                        borderWidth: 3,
                        padding: 15,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13, weight: '600' }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { color: '#00ffff', font: { size: 13, weight: 'bold' } },
                        grid: { color: 'rgba(0, 255, 255, 0.2)', lineWidth: 2 }
                    },
                    x: {
                        ticks: { color: '#ffffff', font: { size: 13, weight: 'bold' } },
                        grid: { color: 'rgba(0, 255, 255, 0.15)', lineWidth: 1 }
                    }
                }
            }
        });
    }

    // Performance Trend Chart
    const trendCanvas = document.getElementById('trendChart');
    if (trendCanvas) {
        const ctx2 = trendCanvas.getContext('2d');
        const gradientTrend = ctx2.createLinearGradient(0, 0, 0, 300);
        gradientTrend.addColorStop(0, 'rgba(255, 0, 255, 0.4)');
        gradientTrend.addColorStop(0.5, 'rgba(0, 255, 255, 0.3)');
        gradientTrend.addColorStop(1, 'rgba(255, 0, 255, 0.4)');
        
        trendChart = new Chart(trendCanvas, {
            type: 'line',
            data: {
                labels: ['Assessment Score'],
                datasets: [{
                    label: 'Score Distribution',
                    data: [document.getElementById('scorePercentage').textContent.replace('%', '')],
                    borderColor: '#00ffff',
                    backgroundColor: gradientTrend,
                    borderWidth: 4,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#ff00ff',
                    pointBorderColor: '#00ffff',
                    pointBorderWidth: 4,
                    pointRadius: 12,
                    pointHoverRadius: 14,
                    pointHoverBackgroundColor: '#00ff00',
                    pointHoverBorderColor: '#ffff00',
                    borderDash: []
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { intersect: false },
                plugins: {
                    legend: { 
                        display: true,
                        labels: {
                            color: '#00ffff',
                            font: { size: 15, weight: 'bold' },
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.95)',
                        titleColor: '#ffff00',
                        bodyColor: '#00ffff',
                        borderColor: '#ff00ff',
                        borderWidth: 3,
                        padding: 15,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13, weight: '600' }
                    }
                },
                scales: {
                    y: { 
                        min: 0, 
                        max: 100,
                        ticks: { color: '#00ff00', font: { size: 13, weight: 'bold' } },
                        grid: { color: 'rgba(0, 255, 0, 0.2)', lineWidth: 2 }
                    },
                    x: {
                        ticks: { color: '#00ffff', font: { size: 13, weight: 'bold' } },
                        grid: { color: 'rgba(0, 255, 255, 0.15)', lineWidth: 2 }
                    }
                }
            }
        });
    }
}

function downloadReport() {
    // Create a simple report
    const report = `
Assessment Results Report
========================

Disorder: ${document.getElementById('disorderName').textContent}
Date: ${document.getElementById('assessmentDate').textContent}
Score: ${document.getElementById('scorePercentage').textContent}
Correct Answers: ${document.getElementById('correctAnswers').textContent}
Time Taken: ${document.getElementById('timeTaken').textContent}
Total Questions: ${document.getElementById('totalQuestions').textContent}

Questions:
${Array.from(document.querySelectorAll('.question-card')).map((card, i) => {
    return `
Q${i+1}: ${card.querySelector('.question-text').textContent}
Status: ${card.classList.contains('correct') ? 'CORRECT' : 'INCORRECT'}
Your Answer: ${card.querySelector('.student-answer').textContent}
`;
}).join('\n')}
    `;

    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(report));
    element.setAttribute('download', 'assessment-report.txt');
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function showError(message) {
    const container = document.querySelector('.assessment-results-container');
    container.innerHTML = `
        <div class="error-message">
            <h2>Error Loading Results</h2>
            <p>${message}</p>
            <button onclick="goToDashboard()">Back to Dashboard</button>
        </div>
    `;
}

// Navigate back to dashboard based on user role
function goToDashboard() {
    const userRole = '{{ session.get("role") }}';
    if (userRole === 'student') {
        window.location.href = '/student-dashboard';
    } else if (userRole === 'faculty') {
        window.location.href = '/faculty-dashboard';
    } else {
        window.location.href = '/';
    }
}
</script>
{% endblock %}
